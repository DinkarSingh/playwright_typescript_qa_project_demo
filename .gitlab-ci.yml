image: mcr.microsoft.com/playwright:v1.30.0-focal

stages:
  - install
  - validate
  - api_test
  - ui_test
  - report

cache:
  paths:
    - node_modules/

install_dependencies:
  stage: install
  script:
    - npm ci

code_format:
  stage: validate
  script:
    - npm run lint
    - npm run format -- --check
  only:
    - master
    - /^.*$/

api_tests:
  stage: api_test
  script:
    - npm ci
    - npx playwright install
    - printenv | grep -i USER || true
    - echo "USER_EMAIL=${USER_EMAIL:-<not set>}"
    - echo "USER_PASSWORD=${USER_PASSWORD:-<not set>}"
    # set JUNIT_FILE env for playwright.config.ts to pick up (avoid invalid CLI reporter syntax)
    - export JUNIT_FILE=playwright-report/api-results.xml
    - npx playwright test --project=public-api --workers=1
  artifacts:
    paths:
      - playwright-report
      - playwright-report/api-results.xml
    reports:
      junit: playwright-report/api-results.xml
  only:
    - master
    - /^.*$/

ui_tests:
  stage: ui_test
  script:
    - npm ci
    - npx playwright install
    - printenv | grep -i USER || true
    - echo "USER_EMAIL=${USER_EMAIL:-<not set>}"
    - echo "USER_PASSWORD=${USER_PASSWORD:-<not set>}"
    - export JUNIT_FILE=playwright-report/ui-results.xml
    - npx playwright test --project=default --workers=1
  dependencies:
    - api_tests
  artifacts:
    paths:
      - playwright-report
      - playwright-report/ui-results.xml
    reports:
      junit: playwright-report/ui-results.xml
  only:
    - master
    - /^.*$/

playwright_report:
  stage: report
  dependencies:
    - api_tests
    - ui_tests
  script:
    - echo "Collecting Playwright HTML report artifacts..."
  artifacts:
    paths:
      - playwright-report
  only:
    - master
    - /^.*$/